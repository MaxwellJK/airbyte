version: "0.70.0"

definitions:
  schema_loader:
    type: JsonFileSchemaLoader
    file_path: "./source_posthog/schemas/{{ parameters['name'] }}.json"

  selector:
    type: RecordSelector
    extractor:
      type: DpathExtractor
      field_path: ["results"]

  requester:
    type: CustomRequester
    class_name: source_posthog.components.PosthogHttpRequester
    url_base: "{{ config['base_url'] or 'https://app.posthog.com'}}/api/"
    http_method: "GET"
    authenticator:
      type: BearerAuthenticator
      api_token: "{{ config['api_key'] }}"

  retriever:
    type: SimpleRetriever
    record_selector:
      $ref: "#/definitions/selector"
    paginator:
      type: "DefaultPaginator"
      page_size_option:
        inject_into: "request_parameter"
        field_name: "limit"
      pagination_strategy:
        type: "OffsetIncrement"
        page_size: "{{ config['page_size'] }}"
      page_token_option:
        type: RequestOption
        field_name: "offset"
        inject_into: "request_parameter"

  base_stream:
    type: DeclarativeStream
    $parameters:
      name: "projects"
    primary_key: "id"
    schema_loader:
      $ref: "#/definitions/schema_loader"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"

  base_incremental_stream:
    $ref: "#/definitions/base_stream"
    retriever:
      $ref: "#/definitions/retriever"
      requester: "#/definitions/requester"
    incremental_sync:
      type: CustomIncrementalSync
      class_name: source_posthog.components.PosthogSlicer
      request_cursor_field: "updated_after"
      cursor_field: "updated_at"
      cursor_datetime_formats:
        - "%Y-%m-%dT%H:%M:%S.%f%z"
        - "%Y-%m-%dT%H:%M:%S+00:00"

  base_slicing_stream:
    $ref: "#/definitions/base_stream"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
        path: "/projects/{{ stream_slice.id }}/{{ parameters['name'] }}"
      partition_router:
        type: SubstreamPartitionRouter
        parent_stream_configs:
          - stream: "#/definitions/projects_stream"
            parent_key: id
            partition_field: id

  projects_stream:
    $ref: "#/definitions/base_stream"
    name: "projects"
    $parameters:
      name: "projects"
      path: "projects"
    retriever:
      $ref: "#/definitions/retriever"
      requester: "#/definitions/requester"


  events_stream:
    $ref: "#/definitions/base_incremental_stream"
    $parameters:
      name: "events"
      path: "events"
    primary_key: "id"
    transformations:
        - type: AddFields
          fields:
            - path: [ "project_id" ]
              value: "{{ stream_slice.project_id }}"
              
    incremental_sync:
      type: CustomIncrementalSync
      class_name: source_posthog.components.PostHogSubstreamSlicer
      request_cursor_field_after: "after"
      request_cursor_field_before: "before"
      cursor_field: "timestamp"
      parent_stream: "#/definitions/projects_stream"
      stream_slice_field: "project_id"
      parent_key: "id"
      cursor_datetime_formats:
        - "%Y-%m-%dT%H:%M:%S.%f%z"
        - "%Y-%m-%dT%H:%M:%S+00:00"
        - "%Y-%m-%d %H:%M:%S.%f%z"
        - "%Y-%m-%d %H:%M:%S+00:00"

      stream_slicers:
        - type: DatetimeBasedCursor
          start_datetime:
            datetime: "{{ config['start_date'] }}"
            datetime_format: "%Y-%m-%dT%H:%M:%S%z"
          end_datetime:
            datetime: "{{ now_utc().strftime('%Y-%m-%dT%H:%M:%S%z') }}"
            datetime_format: "%Y-%m-%dT%H:%M:%S%z"
          datetime_format: "%Y-%m-%dT%H:%M:%S.%f%z"
          cursor_field: timestamp
          start_time_option:
            field_name: after
            inject_into: request_parameter
          end_time_option:
            field_name: before
            inject_into: request_parameter

    retriever:
      $ref: "#/definitions/retriever"
      requester: 
        $ref: "#/definitions/requester"
        path: "/projects/{{ stream_slice.project_id }}/{{ parameters['name'] }}/"
      paginator:
        type: "DefaultPaginator"
        page_size_option:
          inject_into: "request_parameter"
          field_name: "limit"
        pagination_strategy:
          type: "CustomPaginationStrategy"
          class_name: source_posthog.components.PosthogCursorPaginationStrategy
          page_size: "{{ config['page_size'] }}"
          cursor_value: "{{ response['next'] }}"
        page_token_option:
          type: RequestPath
        $parameters:
          url_base: "#/definitions/requester/url_base"




streams:
  - "#/definitions/projects_stream"
  - "#/definitions/cohorts_stream"
  - "#/definitions/feature_flags_stream"
  - "#/definitions/persons_stream"
  - "#/definitions/events_stream"
  - "#/definitions/annotations_stream"
  - "#/definitions/insights_stream"

check:
  type: CheckStream
  stream_names: ["projects"]
